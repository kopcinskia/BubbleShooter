var BubbleShoot=window.BubbleShoot||{}
BubbleShoot.Game=(function($){let Game=function(){let curBubble,board,numBubbles,bubbles=[],MAX_BUBBLES=201,POINTS_PER_BUBBLE=50,level=0,score=0,highScore=0,requestAnimationID,MAX_ROWS=11
this.init=function(){if(BubbleShoot.Renderer){BubbleShoot.Renderer.init(function(){$(".but_start_game").click("click",startGame)})}else{$(".but_start_game").bind("click",startGame)}if(window.localStorage&&localStorage.getItem("high_score")){highScore=parseInt(localStorage.getItem("high_score"))}BubbleShoot.ui.drawHighScore(highScore)}
let startGame=function(){let images=['./img/bubble.jpg','./img/bubbles-bubble-water-macro-86440.jpeg','./img/drop-of-water-drip-blade-of-grass-blossom-55818.jpeg','./img/soap-bubble-colorful-ball-soapy-water.jpg'],i=Math.floor(Math.random()*images.length),gameBackground=document.getElementById('game')
gameBackground.style.background='url('+images[i]+')center'
gameBackground.style.backgroundSize='cover'
$(".but_start_game").unbind("click")
numBubbles=MAX_BUBBLES-level*5;BubbleShoot.ui.hideDialog()
board=new BubbleShoot.Board()
bubbles=board.getBubbles()
curBubble=getNextBubble()
if(BubbleShoot.Renderer){if(!requestAnimationID)requestAnimationID=requestAnimationFrame(renderFrame)}else{BubbleShoot.ui.drawBoard(board)}curBubble=getNextBubble();$("#game").bind("click",clickGameScreen)
BubbleShoot.ui.drawScore(score)
BubbleShoot.ui.drawLevel(level)},getNextBubble=function(){let bubble=BubbleShoot.Bubble.create()
bubbles.push(bubble)
bubble.setState(BubbleShoot.BubbleState.CURRENT)
bubble.getSprite().addClass("cur_bubble")
let top=430,left=($("#board").width()-BubbleShoot.ui.BUBBLE_DIMS)/2
bubble.getSprite().css({top:top,left:left})
$("#board").append(bubble.getSprite())
BubbleShoot.ui.drawBubblesRemaining(numBubbles)
numBubbles--
return bubble},clickGameScreen=function(e){var angle=BubbleShoot.ui.getBubbleAngle(curBubble.getSprite(),e),duration=750,distance=1000,collision=BubbleShoot.CollisionDetector.findIntersection(curBubble,board,angle)
if(collision){var coords=collision.coords
duration=Math.round(duration*collision.distToCollision/distance)
board.addBubble(curBubble,coords)
let group=board.getGroup(curBubble,{})
if(group.list.length>=3){popBubbles(group.list,duration)
let topRow=board.getRows()[0],topRowBubbles=[]
for(let i=0;i<topRow.length;i++){if(topRow[i])topRowBubbles.push(topRow[i])}if(topRowBubbles.length<=5){popBubbles(topRowBubbles,duration)
group.list.concat(topRowBubbles)}let orphans=board.findOrphans(),delay=duration+400+60*group.list.length
dropBubbles(orphans,delay)
let popped=[].concat(group.list,orphans),points=popped.length*POINTS_PER_BUBBLE
score+=points
setTimeout(function(){BubbleShoot.ui.drawScore(score)},delay)}}else{let distX=Math.sin(angle)*distance,distY=Math.cos(angle)*distance,bubbleCoords=BubbleShoot.ui.getBubbleCoords(curBubble.getSprite()),coords={x:bubbleCoords.left+distX,y:bubbleCoords.top-distY}}BubbleShoot.ui.fireBubble(curBubble,coords,duration)
if(board.getRows().length>MAX_ROWS){endGame(false)}else if(numBubbles==0){endGame(false)}else if(board.isEmpty()){endGame(true)}else{curBubble=getNextBubble(board)}},popBubbles=function(bubbles,delay){$.each(bubbles,function(){let bubble=this
setTimeout(function(){bubble.setState(BubbleShoot.BubbleState.POPPING)
bubble.animatePop()
setTimeout(function(){bubble.setState(BubbleShoot.BubbleState.POPPED)},400)
BubbleShoot.Sounds.play("mp3/pop.mp3",Math.random()*.5+.5)},delay)
board.popBubbleAt(this.getRow(),this.getCol())
setTimeout(function(){bubble.getSprite().remove()},delay+400)
delay+=60})},dropBubbles=function(bubbles,delay){$.each(bubbles,function(){let bubble=this
board.popBubbleAt(bubble.getRow(),bubble.getCol())
setTimeout(function(){bubble.setState(BubbleShoot.BubbleState.FALLING)
bubble.getSprite().kaboom({callback:function(){bubble.getSprite().remove()
bubble.setState(BubbleShoot.BubbleState.FALLEN)}})},delay)})},renderFrame=function(){$.each(bubbles,function(){if(this.getSprite().updateFrame)this.getSprite().updateFrame()})
BubbleShoot.Renderer.render(bubbles)
requestAnimationID=requestAnimationFrame(renderFrame)},endGame=function(hasWon){if(score>highScore){highScore=score
$("#new_high_score").show()
BubbleShoot.ui.drawHighScore(highScore)
if(window.localStorage){localStorage.setItem("high_score",highScore)}}else{$("#new_high_score").hide()}if(hasWon){level++}else{score=0
level=0}$(".but_start_game").click("click",startGame)
$("#board .bubble").remove()
BubbleShoot.ui.endGame(hasWon,score)}}
window.requestAnimationFrame=Modernizr.prefixed("requestAnimationFrame",window)||function(callback){window.setTimeout(function(){callback()},40)}
return Game})(jQuery)